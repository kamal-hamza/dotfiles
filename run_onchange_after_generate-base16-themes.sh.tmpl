#!/usr/bin/env bash

# =============================================================================
# Auto-generate Base16 Themes
# =============================================================================
# This script automatically generates Base16 themes using flavours whenever
# the active scheme changes.
#
# Runs automatically when:
# - The active_scheme in .chezmoidata/theme.yaml changes
# - This script itself is modified
#
# Hash: {{ .active_scheme }}
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}[Base16]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[Base16]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[Base16]${NC} $1"
}

print_error() {
    echo -e "${RED}[Base16]${NC} $1"
}

# Configuration
SCHEME="{{ .active_scheme | default "soft-focus-dark" }}"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
SCHEMES_DIR="{{ .chezmoi.sourceDir }}/theme-generators/base16-schemes"
TEMPLATES_DIR="{{ .chezmoi.sourceDir }}/theme-generators/base16-templates"

print_info "Generating Base16 themes for: $SCHEME"

# Check if flavours is installed
if ! command -v flavours &> /dev/null; then
    print_warning "flavours not found - skipping theme generation"
    print_info "Install flavours to enable automatic theme generation:"
    {{- if eq .chezmoi.os "darwin" }}
    echo "  brew install flavours"
    {{- else if eq .chezmoi.os "linux" }}
    {{- if eq .chezmoi.osRelease.id "arch" }}
    echo "  yay -S flavours"
    {{- else }}
    echo "  cargo install flavours"
    {{- end }}
    {{- end }}
    exit 0
fi

# Verify scheme exists
SCHEME_FILE="$SCHEMES_DIR/${SCHEME}.yaml"
if [ ! -f "$SCHEME_FILE" ]; then
    print_error "Scheme not found: $SCHEME"
    print_info "Available schemes:"
    for scheme in "$SCHEMES_DIR"/*.yaml; do
        [ -f "$scheme" ] && echo "  - $(basename "$scheme" .yaml)"
    done
    exit 1
fi

# Create output directories
mkdir -p "$CONFIG_DIR/wezterm/colors"
mkdir -p "$CONFIG_DIR/zed/themes"
mkdir -p "$CONFIG_DIR/nvim/colors"
mkdir -p "$CONFIG_DIR/tmux"
mkdir -p "$CONFIG_DIR/bat/themes"
mkdir -p "$CONFIG_DIR/delta"
mkdir -p "$CONFIG_DIR/fzf"
mkdir -p "$HOME/.config/obsidian/snippets"

# Generate WezTerm theme
print_info "Generating WezTerm theme..."
WEZTERM_TEMPLATE="$TEMPLATES_DIR/wezterm/templates/default.mustache"
WEZTERM_OUTPUT="$CONFIG_DIR/wezterm/colors/base-16-${SCHEME}.lua"

if [ -f "$WEZTERM_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$WEZTERM_TEMPLATE" > "$WEZTERM_OUTPUT" 2>/dev/null; then
        print_success "WezTerm theme generated: base-16-${SCHEME}.lua"
    else
        print_error "Failed to generate WezTerm theme"
    fi
else
    print_warning "WezTerm template not found: $WEZTERM_TEMPLATE"
fi

# Generate Zed theme
print_info "Generating Zed theme..."
ZED_TEMPLATE="$TEMPLATES_DIR/zed/templates/default.mustache"
ZED_OUTPUT="$CONFIG_DIR/zed/themes/base-16-${SCHEME}.json"

if [ -f "$ZED_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$ZED_TEMPLATE" > "$ZED_OUTPUT" 2>/dev/null; then
        print_success "Zed theme generated: base-16-${SCHEME}.json"
    else
        print_error "Failed to generate Zed theme"
    fi
else
    print_warning "Zed template not found: $ZED_TEMPLATE"
fi

# Generate Neovim theme
print_info "Generating Neovim theme..."
NEOVIM_TEMPLATE="$TEMPLATES_DIR/neovim/templates/default.mustache"
NEOVIM_OUTPUT="$CONFIG_DIR/nvim/colors/base16-${SCHEME}.lua"

if [ -f "$NEOVIM_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$NEOVIM_TEMPLATE" > "$NEOVIM_OUTPUT" 2>/dev/null; then
        print_success "Neovim theme generated: base16-${SCHEME}.lua"
    else
        print_error "Failed to generate Neovim theme"
    fi
else
    print_warning "Neovim template not found: $NEOVIM_TEMPLATE"
fi

# Generate Tmux theme
print_info "Generating Tmux theme..."
TMUX_TEMPLATE="$TEMPLATES_DIR/tmux/templates/default.mustache"
TMUX_OUTPUT="$CONFIG_DIR/tmux/base16-${SCHEME}.conf"

if [ -f "$TMUX_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$TMUX_TEMPLATE" > "$TMUX_OUTPUT" 2>/dev/null; then
        print_success "Tmux theme generated: base16-${SCHEME}.conf"
    else
        print_error "Failed to generate Tmux theme"
    fi
else
    print_warning "Tmux template not found: $TMUX_TEMPLATE"
fi

# Generate FZF theme
print_info "Generating FZF theme..."
FZF_TEMPLATE="$TEMPLATES_DIR/fzf/templates/default.mustache"
FZF_OUTPUT="$CONFIG_DIR/fzf/base16-${SCHEME}.sh"

if [ -f "$FZF_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$FZF_TEMPLATE" > "$FZF_OUTPUT" 2>/dev/null; then
        print_success "FZF theme generated: base16-${SCHEME}.sh"
    else
        print_error "Failed to generate FZF theme"
    fi
else
    print_warning "FZF template not found: $FZF_TEMPLATE"
fi

# Generate Bat theme
print_info "Generating Bat theme..."
BAT_TEMPLATE="$TEMPLATES_DIR/bat/templates/default.mustache"
BAT_OUTPUT="$CONFIG_DIR/bat/themes/base16-${SCHEME}.tmTheme"

if [ -f "$BAT_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$BAT_TEMPLATE" > "$BAT_OUTPUT" 2>/dev/null; then
        print_success "Bat theme generated: base16-${SCHEME}.tmTheme"
        # Rebuild bat cache
        if command -v bat &> /dev/null; then
            bat cache --build &> /dev/null
            print_success "Bat cache rebuilt"
        fi
    else
        print_error "Failed to generate Bat theme"
    fi
else
    print_warning "Bat template not found: $BAT_TEMPLATE"
fi

# Generate Git Delta theme
print_info "Generating Git Delta theme..."
DELTA_TEMPLATE="$TEMPLATES_DIR/delta/templates/default.mustache"
DELTA_OUTPUT="$CONFIG_DIR/delta/base16-${SCHEME}.gitconfig"

if [ -f "$DELTA_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$DELTA_TEMPLATE" > "$DELTA_OUTPUT" 2>/dev/null; then
        print_success "Git Delta theme generated: base16-${SCHEME}.gitconfig"
    else
        print_error "Failed to generate Git Delta theme"
    fi
else
    print_warning "Git Delta template not found: $DELTA_TEMPLATE"
fi

# Generate Obsidian theme snippet
print_info "Generating Obsidian theme..."
OBSIDIAN_TEMPLATE="$TEMPLATES_DIR/obsidian/templates/default.mustache"
OBSIDIAN_OUTPUT="$HOME/.config/obsidian/snippets/base16-${SCHEME}.css"

if [ -f "$OBSIDIAN_TEMPLATE" ]; then
    if flavours build "$SCHEME_FILE" "$OBSIDIAN_TEMPLATE" > "$OBSIDIAN_OUTPUT" 2>/dev/null; then
        print_success "Obsidian theme generated: base16-${SCHEME}.css"
    else
        print_error "Failed to generate Obsidian theme"
    fi
else
    print_warning "Obsidian template not found: $OBSIDIAN_TEMPLATE"
fi

print_success "Base16 theme generation complete!"
print_info "Theme files:"
echo "  • WezTerm: $WEZTERM_OUTPUT"
echo "  • Zed: $ZED_OUTPUT"
echo "  • Neovim: $NEOVIM_OUTPUT"
echo "  • Tmux: $TMUX_OUTPUT"
echo "  • FZF: $FZF_OUTPUT"
echo "  • Bat: $BAT_OUTPUT"
echo "  • Delta: $DELTA_OUTPUT"
echo "  • Obsidian: $OBSIDIAN_OUTPUT"
print_info "Additional steps:"
echo "  • Tmux: Add 'source-file $TMUX_OUTPUT' to ~/.tmux.conf"
echo "  • FZF: Source $FZF_OUTPUT in your shell rc file"
echo "  • Delta: Include $DELTA_OUTPUT in your ~/.gitconfig"
echo "  • Obsidian: Enable the snippet in Obsidian settings"