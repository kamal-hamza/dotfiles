# -----------------------------------------------------------------------------
# Helper Functions
# -----------------------------------------------------------------------------
eval_if_exists() {
  local cmd="$1"
  shift
  if command -v "$cmd" >/dev/null 2>&1; then
    eval "$("$cmd" "$@")"
  fi
}

source_if_exists() {
  if [[ -f "$1" && -r "$1" ]]; then
    source "$1"
  fi
}

# -----------------------------------------------------------------------------
# Evals & Sourcing
# -----------------------------------------------------------------------------
eval_if_exists /opt/homebrew/bin/brew shellenv
eval_if_exists /usr/local/bin/brew shellenv
eval_if_exists pyenv init --path
eval_if_exists pyenv init -
eval_if_exists pyenv virtualenv-init -
eval_if_exists zoxide init zsh
eval_if_exists perl -I"$HOME"/perl5/lib/perl5 -Mlocal::lib="$HOME"/perl5

# fzf integration
if command -v fzf >/dev/null 2>&1; then
  source <(fzf --zsh)
fi

# -----------------------------------------------------------------------------
# Initialize Zsh completion system
# -----------------------------------------------------------------------------
autoload -Uz compinit
compinit -C   # use cache for speed

# -----------------------------------------------------------------------------
# Custom Prompt
# -----------------------------------------------------------------------------
LS_COLORS="di=1;37"
autoload -Uz vcs_info
precmd() { vcs_info }
zstyle ':vcs_info:git:*' formats '(%b) '
zstyle ':vcs_info:*' enable git
setopt PROMPT_SUBST
PROMPT='${CONDA_DEFAULT_ENV:+($CONDA_DEFAULT_ENV) }%1~ ${vcs_info_msg_0_}%% '

# -----------------------------------------------------------------------------
# Sourcing
# -----------------------------------------------------------------------------
brew_share_path="${HOMEBREW_PREFIX:-/opt/homebrew}/share"

source_if_exists "$brew_share_path/zsh-autosuggestions/zsh-autosuggestions.zsh"
source_if_exists "$brew_share_path/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
source_if_exists "$brew_share_path/zsh-autopair/autopair.zsh"

source_if_exists "/usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
source_if_exists "/usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
source_if_exists "/usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
source_if_exists "/usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
source_if_exists "/usr/share/zsh/plugins/zsh-autopair/zsh-autopair.plugin.zsh"
source_if_exists "/usr/share/zsh-autopair/autopair.zsh"

source_if_exists "$HOME/.config/zsh/themes/soft-light.zsh"
source_if_exists "$HOME/.cache/wal/colors.sh"

# -----------------------------------------------------------------------------
# Global Aliases
# -----------------------------------------------------------------------------
alias tree='tree -I "node_modules|bower_components"'
alias la='ls -la'
alias l='eza --all --icons'
alias cls='clear'
alias v="nvim"
alias vi="nvim"
alias t="tmux a"
alias cd="z"
alias yy="yazi"
alias gs="git status --short"
alias fman="compgen -c | fzf | xargs man"
alias what='tldr'

# Script Aliases
alias tt="tmux-new.sh"
alias ccp="create-project.sh"
alias dp="delete-project.sh"
alias m="man.sh"
alias bb="branch-change.sh"
alias dc="docker-image-runner.sh"
alias dd="docker-image-stop.sh"
alias ss="stack-search.sh"

# -----------------------------------------------------------------------------
# Conda Initialization (MUST BE LAST)
# -----------------------------------------------------------------------------
conda_paths=(
  "/opt/anaconda3/bin/conda"   # macOS default
  "$HOME/anaconda3/bin/conda"  # Linux default
)

for conda_bin in "${conda_paths[@]}"; do
  if [ -x "$conda_bin" ]; then
    __conda_setup="$("$conda_bin" shell.zsh hook 2> /dev/null)"
    if [ $? -eq 0 ]; then
      eval "$__conda_setup"
    else
      conda_base="${conda_bin%/bin/conda}"
      if [ -f "$conda_base/etc/profile.d/conda.sh" ]; then
        . "$conda_base/etc/profile.d/conda.sh"
      else
        export PATH="$conda_base/bin:$PATH"
      fi
    fi
    unset __conda_setup
    break  # stop after first working conda
  fi
done
