{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# =============================================================================
# macOS System Configuration Script
# =============================================================================
# This script configures macOS system preferences and settings
# It runs once on initial setup (or when the script content changes)
#
# To re-run this script after editing, either:
# 1. Delete the state file: rm ~/.config/chezmoi/chezmoistate.boltdb
# 2. Or run: chezmoi state delete-bucket --bucket=scriptState
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC}  $1"
}

print_header "macOS System Configuration"

print_warning "This will modify your macOS system preferences"
print_info "Some changes may require logging out or restarting"
echo ""

# =============================================================================
# Appearance
# =============================================================================
print_header "Appearance"

# Set dark mode
print_info "Setting dark mode..."
osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to true' 2>/dev/null || \
defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"
print_success "Dark mode enabled"

# Set accent color to pink
print_info "Setting accent color to pink..."
defaults write NSGlobalDomain AppleAccentColor -int 6
print_success "Accent color set to pink"

# Set icon theme to dark (multicolor in dark mode)
print_info "Setting icon theme..."
defaults write NSGlobalDomain AppleInterfaceStyleSwitchesAutomatically -bool false
print_success "Icon theme set to dark"

# =============================================================================
# Dock
# =============================================================================
print_header "Dock"

# Set Dock size to 30% (roughly 36 pixels on standard display)
print_info "Setting Dock size to 30%..."
defaults write com.apple.dock tilesize -int 36
print_success "Dock size set to 30%"

# Set Dock position to right
print_info "Setting Dock position to right..."
defaults write com.apple.dock orientation -string "right"
print_success "Dock positioned on right"

# Hide recent applications in Dock
print_info "Hiding recent applications..."
defaults write com.apple.dock show-recents -bool false
print_success "Recent applications hidden"

# Note: "Suggested apps" in Dock is controlled by show-recents

# Enable Dock auto-hide
print_info "Enabling Dock auto-hide..."
defaults write com.apple.dock autohide -bool true
print_success "Dock auto-hide enabled"

# Reduce Dock auto-hide delay for faster response
print_info "Setting fast auto-hide delay..."
defaults write com.apple.dock autohide-delay -float 0.0
defaults write com.apple.dock autohide-time-modifier -float 0.4
print_success "Fast auto-hide configured"

# =============================================================================
# Keyboard
# =============================================================================
print_header "Keyboard"

# Set key repeat rate to maximum (fastest)
print_info "Setting key repeat to maximum speed..."
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 10
print_success "Key repeat set to maximum speed"

# =============================================================================
# Finder
# =============================================================================
print_header "Finder"

# Show path bar in Finder
print_info "Showing path bar..."
defaults write com.apple.finder ShowPathbar -bool true
print_success "Path bar visible"

# Show full path in Finder title bar
print_info "Showing full path in title bar..."
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true
print_success "Full path in title bar enabled"

# Set Finder to display files/folders as list
print_info "Setting default view to list..."
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
print_success "List view set as default"

# Apply list view to all windows
print_info "Applying list view to all Finder windows..."
/usr/bin/find ~/Library/Preferences -name "com.apple.finder.plist" -exec defaults write {} FXPreferredViewStyle -string "Nlsv" \; 2>/dev/null || true
print_success "List view applied to all windows"

# =============================================================================
# Trackpad
# =============================================================================
print_header "Trackpad"

# Enable tap to click
print_info "Enabling tap to click..."
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
print_success "Tap to click enabled"

# Set secondary click to bottom right corner
print_info "Setting secondary click to bottom right..."
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1
defaults -currentHost write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true
print_success "Secondary click set to bottom right"

# =============================================================================
# Done
# =============================================================================
print_header "Configuration Complete!"

echo -e "${GREEN}All macOS settings have been applied!${NC}"
echo ""
echo -e "${YELLOW}Restarting affected applications...${NC}"
echo ""

# Restart affected applications
for app in "Dock" "Finder" "SystemUIServer"; do
    print_info "Restarting ${app}..."
    killall "${app}" &> /dev/null || true
done

print_success "Applications restarted"
echo ""
print_success "macOS configuration complete!"
echo ""
print_warning "Note: Some settings may require logging out or restarting your Mac to take full effect"
echo ""

{{ end -}}
