{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# chezmoi: run_once
#
# This script sets up the symbolic link for the dynamic Zed theme on Arch Linux.
# It ensures that Zed can find the theme file generated by pywal.

set -euo pipefail

# Define the source and destination for the theme symlink
ZED_THEMES_DIR="$HOME/.config/zed/themes"
PYWAL_CACHE_DIR="$HOME/.cache/wal"
SOURCE_THEME_FILE="$PYWAL_CACHE_DIR/pywal-zed-vesper.json"
DEST_SYMLINK="$ZED_THEMES_DIR/pywal-theme.json"

echo "› Setting up Zed theme symlink for Arch Linux..."

# 1. Ensure the pywal cache directory exists
mkdir -p "$PYWAL_CACHE_DIR"

# 2. Run pywal on the default wallpaper to generate the initial theme file
#    This is necessary so the symlink has a valid target to point to.
#    The '-n' flag skips setting the wallpaper, and '-s' skips sending terminal sequences.
if [ ! -f "$SOURCE_THEME_FILE" ]; then
    echo ":: Pywal theme not found, generating from default wallpaper..."
    wal -s -n -i "$HOME/.config/wallpapers/default.jpg"
fi

# 3. Ensure Zed's themes directory exists
mkdir -p "$ZED_THEMES_DIR"

# 4. Create the symbolic link if it doesn't already exist
if [ -L "$DEST_SYMLINK" ]; then
    echo "✅ Zed theme symlink already exists."
elif [ -e "$DEST_SYMLINK" ]; then
    echo "⚠️  Warning: A file already exists at $DEST_SYMLINK but it is not a symlink. Please remove it manually."
else
    echo ":: Creating Zed theme symlink..."
    ln -s "$SOURCE_THEME_FILE" "$DEST_SYMLINK"
    echo "✅ Zed theme symlink created."
fi
{{ end -}}
