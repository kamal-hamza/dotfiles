{{ if eq .chezmoi.os "linux" -}}
{{ if eq .chezmoi.osRelease.id "nixos" -}}
#!/usr/bin/env bash

# NixOS Automated Installation via Chezmoi
# This script runs once before any other chezmoi operations on a fresh NixOS install

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_step() {
    echo -e "\n${GREEN}==>${NC} ${BLUE}$1${NC}\n"
}

# Check if we're in the NixOS installer environment
is_nixos_installer() {
    # Check if /mnt exists and is empty (typical installer env)
    # Also check if we're not already on an installed system
    if [ -d "/mnt" ] && [ ! -f "/etc/NIXOS" ]; then
        # Additional check: see if we have nixos-install available
        if command -v nixos-install >/dev/null 2>&1; then
            # Check if /mnt is not already mounted with a nixos system
            if [ ! -f "/mnt/etc/NIXOS" ]; then
                return 0
            fi
        fi
    fi
    return 1
}

# Check if NixOS is already installed
is_nixos_installed() {
    [ -f "/etc/NIXOS" ]
}

# Main installation logic
if is_nixos_installed; then
    print_info "NixOS is already installed. Skipping installer script."
    exit 0
fi

if ! is_nixos_installer; then
    print_info "Not in NixOS installer environment. Skipping installer script."
    exit 0
fi

# We're in the installer environment - proceed with installation
print_step "NixOS Automated Installation"

cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘     Chezmoi-Driven NixOS Installation                        â•‘
â•‘     Hyprland + Wayland Development Setup                     â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF

print_warning "This script will install NixOS on your system."
print_warning "This is a DESTRUCTIVE operation that will erase your disk!"
echo ""

# Get user confirmation
read -p "Do you want to proceed with the automated installation? [y/N]: " CONFIRM
CONFIRM=${CONFIRM:-N}

if [[ ! $CONFIRM =~ ^[Yy]$ ]]; then
    print_info "Installation cancelled by user."
    exit 0
fi

# Get installation parameters
print_step "Installation Configuration"

read -p "Enter your desired hostname [nixos]: " HOSTNAME
HOSTNAME=${HOSTNAME:-nixos}

read -p "Enter your username [{{ .chezmoi.username }}]: " USERNAME
USERNAME=${USERNAME:-{{ .chezmoi.username }}}

read -p "Enter your full name [Hamza Kamal]: " FULLNAME
FULLNAME=${FULLNAME:-"Hamza Kamal"}

read -p "Enter your email: " EMAIL

read -p "Enter your timezone [America/New_York]: " TIMEZONE
TIMEZONE=${TIMEZONE:-"America/New_York"}

echo ""
print_info "GPU Type:"
echo "  1) Intel"
echo "  2) NVIDIA"
echo "  3) AMD"
read -p "Select your GPU type [1]: " GPU_TYPE
GPU_TYPE=${GPU_TYPE:-1}

# Disk selection
print_step "Disk Selection"
print_warning "Available disks:"
lsblk -d -o NAME,SIZE,TYPE,MODEL | grep disk
echo ""

read -p "Enter the disk to use (e.g., sda, nvme0n1) [REQUIRED]: " DISK_NAME
if [ -z "$DISK_NAME" ]; then
    print_error "Disk name is required!"
    exit 1
fi

DISK="/dev/$DISK_NAME"

if [ ! -b "$DISK" ]; then
    print_error "Disk $DISK does not exist"
    exit 1
fi

# Show summary
echo ""
print_info "Installation Summary:"
echo "  Hostname:  $HOSTNAME"
echo "  Username:  $USERNAME"
echo "  Full Name: $FULLNAME"
echo "  Email:     ${EMAIL:-not set}"
echo "  Timezone:  $TIMEZONE"
case $GPU_TYPE in
    1) echo "  GPU:       Intel" ;;
    2) echo "  GPU:       NVIDIA" ;;
    3) echo "  GPU:       AMD" ;;
esac
echo "  Disk:      $DISK"
echo ""

print_warning "This will COMPLETELY ERASE $DISK!"
read -p "Type 'yes' to confirm and proceed: " FINAL_CONFIRM

if [ "$FINAL_CONFIRM" != "yes" ]; then
    print_error "Installation cancelled."
    exit 1
fi

# Start installation
print_step "Partitioning Disk"

print_info "Creating partitions on $DISK..."

# Unmount if already mounted
umount -R /mnt 2>/dev/null || true

# Partition the disk
parted $DISK -- mklabel gpt
parted $DISK -- mkpart ESP fat32 1MiB 512MiB
parted $DISK -- set 1 esp on
parted $DISK -- mkpart primary 512MiB 100%

# Determine partition naming scheme
if [[ $DISK == *"nvme"* ]] || [[ $DISK == *"mmcblk"* ]]; then
    BOOT_PART="${DISK}p1"
    ROOT_PART="${DISK}p2"
else
    BOOT_PART="${DISK}1"
    ROOT_PART="${DISK}2"
fi

# Wait for partitions to be ready
sleep 2

print_info "Formatting partitions..."
mkfs.fat -F 32 -n boot $BOOT_PART
mkfs.ext4 -F -L nixos $ROOT_PART

print_info "Mounting partitions..."
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/boot /mnt/boot

print_success "Disk prepared successfully"

# Generate hardware configuration
print_step "Generating Hardware Configuration"

nixos-generate-config --root /mnt

print_success "Hardware configuration generated"

# Copy NixOS configuration
print_step "Installing NixOS Configuration"

print_info "Copying configuration files..."

# The chezmoi source directory
CHEZMOI_SOURCE="${HOME}/.local/share/chezmoi"

# Copy NixOS config files
cp -r "$CHEZMOI_SOURCE/nixos/"* /mnt/etc/nixos/

# Preserve the generated hardware config
cp /mnt/etc/nixos/hardware-configuration.nix /tmp/hw-config-backup.nix
rm -f /mnt/etc/nixos/hardware-configuration.nix
mv /tmp/hw-config-backup.nix /mnt/etc/nixos/hardware-configuration.nix

print_success "Configuration files copied"

# Customize configuration
print_step "Customizing Configuration"

cd /mnt/etc/nixos

# Update hostname
sed -i "s/hostName = \"nixos\"/hostName = \"$HOSTNAME\"/" configuration.nix

# Update timezone
sed -i "s|time.timeZone = \"America/New_York\"|time.timeZone = \"$TIMEZONE\"|" configuration.nix

# Update username in configuration.nix
sed -i "s/users.users.hkamal {/users.users.$USERNAME {/" configuration.nix
sed -i "s/description = \"Hamza Kamal\"/description = \"$FULLNAME\"/" configuration.nix

# Update flake.nix
sed -i "s/nixos = nixpkgs.lib.nixosSystem/\"$HOSTNAME\" = nixpkgs.lib.nixosSystem/" flake.nix

# Update git config in configuration.nix
if [ -n "$EMAIL" ]; then
    # Add git config to configuration.nix if not exists
    if ! grep -q "programs.git.config" configuration.nix; then
        echo "Git config will be set via chezmoi dotfiles"
    fi
fi

# Configure GPU
case $GPU_TYPE in
    2) # NVIDIA
        print_info "Configuring NVIDIA GPU..."
        # Uncomment NVIDIA configuration in hardware-configuration.nix
        sed -i '/# For NVIDIA GPUs, uncomment:/,/# };/s/^  # /  /' hardware-configuration.nix
        # Update Ollama acceleration
        sed -i 's/acceleration = "cuda"; # Change to "rocm"/acceleration = "cuda";/' modules/services.nix
        ;;
    3) # AMD
        print_info "Configuring AMD GPU..."
        # Uncomment AMD configuration in hardware-configuration.nix
        sed -i '/# For AMD GPUs, uncomment:/,/# ];/s/^  # /  /' hardware-configuration.nix
        # Update Ollama acceleration
        sed -i 's/acceleration = "cuda"; # Change to "rocm"/acceleration = "rocm";/' modules/services.nix
        ;;
    *) # Intel (default)
        print_info "Using Intel GPU configuration..."
        # Intel is already configured by default
        ;;
esac

print_success "Configuration customized"

# Install NixOS
print_step "Installing NixOS"

print_warning "This will take 10-30 minutes depending on your internet connection..."
print_info "Installing NixOS with flakes..."

# Install with flakes
nixos-install --flake ".#$HOSTNAME" --no-root-passwd

print_success "NixOS installed successfully!"

# Set user password
print_step "Setting User Password"

print_info "Please set a password for user: $USERNAME"
nixos-enter --root /mnt -c "passwd $USERNAME"

# Post-installation instructions
print_step "Installation Complete!"

cat << EOF

${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘     NixOS Installation Completed Successfully! ðŸŽ‰            â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}

${BLUE}What just happened:${NC}
âœ“ Disk partitioned and formatted
âœ“ NixOS installed with Hyprland configuration
âœ“ Your dotfiles configuration applied
âœ“ User account created

${BLUE}Next Steps:${NC}

1. ${YELLOW}Reboot into your new system:${NC}
   ${GREEN}reboot${NC}

2. ${YELLOW}After reboot and login:${NC}
   - Hyprland should start automatically
   - Your terminal: ${GREEN}SUPER + Q${NC}
   - App launcher: ${GREEN}SUPER + SPACE${NC}

3. ${YELLOW}Apply your complete dotfiles (if not already applied):${NC}
   ${GREEN}chezmoi apply${NC}

   Or re-initialize with:
   ${GREEN}chezmoi init --apply kamal-hamza${NC}

4. ${YELLOW}Configure any remaining applications${NC}

${BLUE}Useful NixOS Commands:${NC}

Rebuild system:        ${GREEN}sudo nixos-rebuild switch${NC}
Update packages:       ${GREEN}sudo nix flake update${NC}
Clean old versions:    ${GREEN}sudo nix-collect-garbage -d${NC}
List generations:      ${GREEN}sudo nix-env --list-generations --profile /nix/var/nix/profiles/system${NC}

${BLUE}Configuration Location:${NC}
/etc/nixos/

${BLUE}Hyprland Keybindings:${NC}
Mod key:        ${GREEN}SUPER${NC}
Terminal:       ${GREEN}SUPER + Q${NC}
Browser:        ${GREEN}SUPER + E${NC}
Editor:         ${GREEN}SUPER + W${NC}
File Manager:   ${GREEN}SUPER + R${NC}
Launcher:       ${GREEN}SUPER + SPACE${NC}
Kill Window:    ${GREEN}SUPER + X${NC}

${BLUE}Documentation:${NC}
See /etc/nixos/README.md for complete documentation

${GREEN}Enjoy your reproducible NixOS setup! ðŸš€${NC}

EOF

# Create a marker file to prevent re-running
touch /mnt/etc/nixos/.installed-by-chezmoi

print_info "Rebooting in 10 seconds... (Press Ctrl+C to cancel)"
sleep 10

reboot

{{ end -}}
{{ end -}}
