{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# =============================================================================
# Arch Linux Package Installation Script
# =============================================================================
# This script automatically installs packages defined in .chezmoidata/packages.yaml
# It runs whenever the package list changes (via chezmoi's run_onchange feature)
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Main script
print_header "Arch Linux Package Installation"

# -----------------------------------------------------------------------------
# Step 1: Update system and install base-devel
# -----------------------------------------------------------------------------
print_info "Updating system and ensuring base-devel is installed..."

if sudo pacman -Syu --noconfirm --needed base-devel git &> /dev/null; then
    print_success "System updated and base-devel installed"
else
    print_error "Failed to update system"
    exit 1
fi

# -----------------------------------------------------------------------------
# Step 2: Install yay (AUR helper)
# -----------------------------------------------------------------------------
print_info "Checking for yay (AUR helper)..."

if ! command -v yay &> /dev/null; then
    print_warning "yay not found. Installing..."
    
    # Create temp directory
    TEMP_DIR=$(mktemp -d)
    cd "$TEMP_DIR"
    
    # Clone and install yay
    if git clone https://aur.archlinux.org/yay-bin.git &> /dev/null; then
        cd yay-bin
        if makepkg -si --noconfirm &> /dev/null; then
            print_success "yay installed successfully"
        else
            print_error "Failed to build yay"
            cd ~
            rm -rf "$TEMP_DIR"
            exit 1
        fi
    else
        print_error "Failed to clone yay repository"
        cd ~
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    
    # Cleanup
    cd ~
    rm -rf "$TEMP_DIR"
else
    print_success "yay is already installed"
fi

# -----------------------------------------------------------------------------
# Step 3: Install Official Repository Packages
# -----------------------------------------------------------------------------
{{ if .packages.arch.pacman -}}
print_header "Installing Official Repository Packages"

PACMAN_PACKAGES=(
{{- range .packages.arch.pacman }}
    {{ . | quote }}
{{- end }}
)

for package in "${PACMAN_PACKAGES[@]}"; do
    if pacman -Qi "$package" &> /dev/null; then
        print_success "$package (already installed)"
    else
        print_info "Installing $package..."
        if sudo pacman -S --noconfirm --needed "$package" &> /dev/null; then
            print_success "$package installed"
        else
            print_error "Failed to install $package"
        fi
    fi
done
{{ else -}}
print_warning "No official repository packages defined in packages.yaml"
{{ end -}}

# -----------------------------------------------------------------------------
# Step 4: Install AUR Packages
# -----------------------------------------------------------------------------
{{ if .packages.arch.aur -}}
print_header "Installing AUR Packages"

AUR_PACKAGES=(
{{- range .packages.arch.aur }}
    {{ . | quote }}
{{- end }}
)

for package in "${AUR_PACKAGES[@]}"; do
    if yay -Qi "$package" &> /dev/null; then
        print_success "$package (already installed)"
    else
        print_info "Installing $package..."
        if yay -S --noconfirm --needed "$package" &> /dev/null; then
            print_success "$package installed"
        else
            print_error "Failed to install $package"
        fi
    fi
done
{{ else -}}
print_warning "No AUR packages defined in packages.yaml"
{{ end -}}

# -----------------------------------------------------------------------------
# Step 5: Cleanup
# -----------------------------------------------------------------------------
print_header "Cleanup"
print_info "Removing unused packages and cleaning cache..."

if yay -Sc --noconfirm &> /dev/null; then
    print_success "Cleanup complete"
else
    print_warning "Cleanup had some issues (non-critical)"
fi

# -----------------------------------------------------------------------------
# Done
# -----------------------------------------------------------------------------
print_header "Installation Complete!"
echo -e "${GREEN}All packages have been processed.${NC}"
echo ""
echo "To add more packages, edit:"
echo "  ~/.local/share/chezmoi/.chezmoidata/packages.yaml"
echo ""
echo "Then run:"
echo "  chezmoi apply"
echo ""

{{ end -}}