#!/usr/bin/env bash

# ==============================================================================
#
#          Project Creator & Tmux Session Manager
#
#  Features:
#  - Clone existing GitHub repositories
#  - Create empty projects
#  - Auto-open in tmux session with editor
#
#  Dependencies: fzf, tmux, gh (GitHub CLI)
#
# ==============================================================================

set -e

# --- Configuration ---
CODE_DIR="${CODE_DIR:-$HOME/Code}"
MY_EDITOR="${EDITOR:-zed}"

# --- Helper Functions ---

get_github_repo() {
    if ! command -v gh &>/dev/null; then
        echo "Error: GitHub CLI (gh) not installed." >&2
        exit 1
    fi
    gh repo list --limit 300 | fzf --height 50% --reverse --prompt="Clone Repo: " | awk '{print $1}'
}

# --- Main Logic ---

echo "Project Creator"
echo ""

# Ensure CODE_DIR exists
if [[ ! -d "$CODE_DIR" ]]; then
    mkdir -p "$CODE_DIR"
fi

# Choose Action
ACTION=$(printf "Clone Existing Repo\nCreate Empty Folder" | \
    fzf --height 40% --reverse --prompt="Action: ")

if [[ -z "$ACTION" ]]; then
    echo "No action selected. Exiting."
    exit 1
fi

# Execute Action
case "$ACTION" in
    "Clone Existing Repo")
        REPO=$(get_github_repo)
        [[ -z "$REPO" ]] && exit 1

        PROJECT_NAME=$(basename "$REPO")
        PROJECT_PATH="$CODE_DIR/$PROJECT_NAME"

        echo "Cloning $REPO into $CODE_DIR..."
        cd "$CODE_DIR"
        gh repo clone "$REPO"
        ;;

    "Create Empty Folder")
        read -rp "Project Name: " PROJECT_NAME
        [[ -z "$PROJECT_NAME" ]] && exit 1

        PROJECT_PATH="$CODE_DIR/$PROJECT_NAME"
        
        if [[ -d "$PROJECT_PATH" ]]; then
            echo "Warning: Directory '$PROJECT_PATH' already exists."
            read -rp "Continue anyway? (y/N): " CONTINUE
            [[ ! "$CONTINUE" =~ ^[Yy]$ ]] && exit 1
        else
            mkdir -p "$PROJECT_PATH"
        fi
        
        cd "$PROJECT_PATH"
        touch README.md
        ;;

    *)
        echo "Invalid action." >&2
        exit 1
        ;;
esac

# Tmux and Editor Integration
cd "$PROJECT_PATH"

echo ""
echo "Project ready at: $PROJECT_PATH"
echo ""

# Create or attach to tmux session
if tmux has-session -t "$PROJECT_NAME" 2>/dev/null; then
    echo "Tmux session '$PROJECT_NAME' already exists."
else
    echo "Creating tmux session '$PROJECT_NAME'..."
    tmux new-session -s "$PROJECT_NAME" -c "$PROJECT_PATH" -d

    # Open editor in the session
    if [[ -n "$MY_EDITOR" ]]; then
        tmux send-keys -t "$PROJECT_NAME" "$MY_EDITOR ." C-m
    fi
fi

echo "Attaching to session: $PROJECT_NAME"
echo ""
tmux attach-session -t "$PROJECT_NAME"