#!/usr/bin/env zsh
# =============================================================================
# FZF History Pro - Advanced fuzzy history search with smart ranking
# =============================================================================
# Features:
# - Smart ranking based on frequency and recency
# - Project-aware scoring (git repositories)
# - Syntax highlighting preview with bat
# - Multi-line command support
# - Works across all tmux sessions and terminals
# =============================================================================

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------

HISTORY_LIMIT=5000
FZF_HEIGHT="50%"

# Ensure history is loaded
HISTFILE="${HISTFILE:-$HOME/.zsh_history}"

# Detect project root (git-aware)
project_root() {
  git rev-parse --show-toplevel 2>/dev/null || pwd
}

PROJECT_KEY=$(project_root)

# -----------------------------------------------------------------------------
# Collect History
# -----------------------------------------------------------------------------

collect_history() {
  # Read directly from history file for cross-session history
  if [[ -f "$HISTFILE" ]]; then
    # Parse zsh history file format (handles timestamps and multiline)
    perl -ne 'if (/^: \d+:\d+;(.*)/) { print "$1\n" } elsif (!/^:/) { print }' "$HISTFILE" \
    | tail -n $HISTORY_LIMIT \
    | awk '!seen[$0]++'
  else
    # Fallback to fc if history file doesn't exist
    fc -rl 1 2>/dev/null \
    | head -n $HISTORY_LIMIT \
    | sed 's/^[[:space:]]*[0-9]\+[[:space:]]*//' \
    | awk '!seen[$0]++'
  fi
}

# -----------------------------------------------------------------------------
# Smart Ranking Algorithm
# -----------------------------------------------------------------------------
# Scoring factors:
# - Frequency: How often the command is used (weight: 10)
# - Project relevance: Commands used in current project (weight: 5)
# - Recency: More recent commands ranked higher (weight: -0.01)
# -----------------------------------------------------------------------------

rank_history() {
  awk -v proj="$PROJECT_KEY" '
    {
      cmd=$0
      freq[cmd]++
      last_seen[cmd]=NR
      
      # Boost score if command contains project path
      if (index(cmd, proj)) {
        proj_score[cmd]+=5
      }
      
      # Boost score for common development commands
      if (match(cmd, /^(git|npm|yarn|pnpm|docker|kubectl|cargo|go|python|make|cd|z)/)) {
        dev_score[cmd]+=2
      }
    }
    END {
      for (c in freq) {
        # Calculate final score
        score = (freq[c] * 10) + proj_score[c] + dev_score[c] - (last_seen[c] * 0.01)
        printf "%08.2f\t%s\n", score, c
      }
    }
  ' \
  | sort -nr \
  | cut -f2-
}

# -----------------------------------------------------------------------------
# FZF Interface
# -----------------------------------------------------------------------------

fzf_run() {
  local history_output
  history_output=$(collect_history)
  
  # Check if we have any history
  if [[ -z "$history_output" ]]; then
    echo "No history found. Run some commands first!" >&2
    return 1
  fi
  
  echo "$history_output" \
  | rank_history \
  | fzf \
      --height="$FZF_HEIGHT" \
      --reverse \
      --prompt="History ‚ùØ " \
      --info=inline \
      --border=rounded \
      --ansi \
      --no-sort \
      --exact \
      --header="^Y: Copy | Enter: Select | Esc: Cancel" \
      --bind='ctrl-y:execute-silent(echo -n {} | pbcopy)+abort' \
      --color='border:#448cbb,header:#888888,prompt:#67b7f5,pointer:#ff4c6a'
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

selected="$(fzf_run)"

# Exit if nothing selected
[[ -z "$selected" ]] && exit 0

# Print selected command (can be captured or executed by caller)
echo "$selected"
